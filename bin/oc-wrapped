#!/usr/bin/env node

import { spawnSync } from "node:child_process";
import fs from "node:fs";
import { dirname, join } from "node:path";
import { platform as osPlatform, arch as osArch } from "node:os";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const platformMap = {
  darwin: "darwin",
  linux: "linux",
  win32: "windows",
};
const archMap = {
  x64: "x64",
  arm64: "arm64",
};

let platform = platformMap[osPlatform()];
if (!platform) {
  platform = osPlatform();
}
let arch = archMap[osArch()];
if (!arch) {
  arch = osArch();
}
const base = "oc-wrapped-" + platform + "-" + arch;
const binary = platform === "windows" ? "oc-wrapped.exe" : "oc-wrapped";
const VERSION_CHECK_TIMEOUT = 5000;

function findAllBinaries(startDir) {
  const binaries = [];
  let current = startDir;
  for (;;) {
    const modules = join(current, "node_modules");
    if (fs.existsSync(modules)) {
      const entries = fs.readdirSync(modules);
      for (const entry of entries) {
        if (!entry.startsWith(base)) {
          continue;
        }
        const candidate = join(modules, entry, "bin", binary);
        if (fs.existsSync(candidate)) {
          binaries.push({ path: candidate, package: entry });
        }
      }
    }
    const parent = dirname(current);
    if (parent === current) {
      break;
    }
    current = parent;
  }
  return binaries;
}

// Find all available binaries for this platform
const binaries = findAllBinaries(__dirname);

if (binaries.length === 0) {
  console.error(
    'It seems that your package manager failed to install the right version of oc-wrapped CLI for your platform. You can try manually installing "' +
      base +
      '" package'
  );
  process.exit(1);
}

// Sort binaries: baseline variants last (as fallback)
binaries.sort((a, b) => {
  const aIsBaseline = a.package.includes("baseline");
  const bIsBaseline = b.package.includes("baseline");
  if (aIsBaseline && !bIsBaseline) return 1;
  if (!aIsBaseline && bIsBaseline) return -1;
  return 0;
});

// Try each binary in order until one works
let lastError = null;
for (let i = 0; i < binaries.length; i++) {
  const { path: binaryPath } = binaries[i];
  
  // For non-last binaries, try with a version check first to detect symbol errors
  if (i < binaries.length - 1) {
    const testResult = spawnSync(binaryPath, ["--version"], {
      stdio: "pipe",
      timeout: VERSION_CHECK_TIMEOUT,
    });
    
    if (testResult.error) {
      // Binary failed to execute (e.g., symbol relocation errors)
      lastError = testResult.error;
      continue;
    }
  }
  
  // Run the binary normally with all arguments
  const result = spawnSync(binaryPath, process.argv.slice(2), {
    stdio: "inherit",
  });
  
  if (result.error) {
    lastError = result.error;
    if (i < binaries.length - 1) {
      // Try next binary
      continue;
    }
    // Last binary also failed - fall through to error handling
    break;
  }
  
  // Binary executed successfully (even if exit code is non-zero)
  const code = typeof result.status === "number" ? result.status : 0;
  process.exit(code);
}

// All binaries failed to execute
console.error("Failed to execute oc-wrapped binary.");
if (lastError) {
  console.error(lastError.message);
}
process.exit(1);
